<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur App Mobile - Polling 1 seconde</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .phone-simulator {
            max-width: 400px;
            margin: 0 auto;
            background: #fff;
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .phone-header {
            background: linear-gradient(135deg, #D4A853, #B8941F);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .phone-header h1 {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .phone-header .coursier-info {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .status-bar {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        
        .status-dot.active {
            background: #27ae60;
        }
        
        .status-dot.polling {
            background: #3498db;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.9); }
        }
        
        .polling-info {
            font-size: 0.8rem;
            color: #666;
        }
        
        .commandes-list {
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .commande-card {
            background: #fff;
            border: 2px solid #D4A853;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .commande-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .commande-code {
            font-weight: bold;
            color: #D4A853;
            font-size: 1.1rem;
        }
        
        .commande-prix {
            background: #27ae60;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .commande-details {
            margin: 10px 0;
            line-height: 1.6;
        }
        
        .commande-details div {
            display: flex;
            align-items: flex-start;
            margin: 8px 0;
            gap: 8px;
        }
        
        .commande-details .icon {
            min-width: 20px;
        }
        
        .commande-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }
        
        .btn-accept {
            background: #27ae60;
            color: white;
        }
        
        .btn-accept:hover {
            background: #229954;
            transform: translateY(-2px);
        }
        
        .btn-refuse {
            background: #e74c3c;
            color: white;
        }
        
        .btn-refuse:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        
        .no-commandes {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .no-commandes .icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .logs {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .log-time {
            color: #3498db;
        }
        
        .log-success {
            color: #27ae60;
        }
        
        .log-error {
            color: #e74c3c;
        }
        
        /* MODAL POUR NOUVELLE COMMANDE */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-overlay.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: slideUp 0.4s ease;
            position: relative;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .modal-icon {
            font-size: 4rem;
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #D4A853;
            margin: 10px 0;
        }
        
        .modal-body {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .modal-detail {
            display: flex;
            align-items: flex-start;
            margin: 10px 0;
            font-size: 0.95rem;
        }
        
        .modal-detail .icon {
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .modal-btn-accept {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }
        
        .modal-btn-accept:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }
        
        .modal-btn-refuse {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .modal-btn-refuse:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        /* ANIMATION D'ALERTE */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .phone-simulator.alert {
            animation: shake 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="phone-simulator">
        <div class="phone-header">
            <h1>üöö Coursier Suzosky</h1>
            <div class="coursier-info">Coursier #5 - ZALLE Ismael</div>
        </div>
        
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot polling"></div>
                <span class="polling-info">Polling: <strong id="polling-interval">1s</strong></span>
            </div>
            <div class="status-indicator">
                <div class="status-dot active"></div>
                <span class="polling-info">Connect√©</span>
            </div>
        </div>
        
        <div class="commandes-list" id="commandes-list">
            <div class="no-commandes">
                <div class="icon">üì¶</div>
                <p>En attente de nouvelles commandes...</p>
                <small>Polling actif toutes les 1 seconde</small>
            </div>
        </div>
        
        <div class="logs" id="logs">
            <div class="log-entry">
                <span class="log-time">[--:--:--]</span> D√©marrage du polling...
            </div>
        </div>
    </div>
    
    <!-- MODAL POUR NOUVELLE COMMANDE -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-content" id="modal-content">
            <!-- Contenu inject√© dynamiquement -->
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost/COURSIER_LOCAL';
        const COURSIER_ID = 5;
        const POLLING_INTERVAL = 1000; // 1 seconde
        
        let lastCommandes = [];
        let pollingCount = 0;
        
        // Demander la permission pour les notifications syst√®me
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    addLog('‚úÖ Notifications syst√®me activ√©es', 'success');
                }
            });
        }
        
        function showSystemNotification(commande) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification('üö® Nouvelle Commande Suzosky!', {
                    body: `${commande.code_commande}\nDe: ${commande.adresse_depart}\nVers: ${commande.adresse_arrivee}\nPrix: ${commande.prix_estime || commande.prix_total || '0'} FCFA`,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="80" font-size="80">üöö</text></svg>',
                    requireInteraction: true,
                    tag: 'commande-' + commande.id
                });
                
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
            }
        }
        
        function addLog(message, type = 'info') {
            const logs = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            let className = '';
            if (type === 'success') className = 'log-success';
            if (type === 'error') className = 'log-error';
            
            entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="${className}">${message}</span>`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
            
            // Garder seulement les 50 derniers logs
            while (logs.children.length > 50) {
                logs.removeChild(logs.firstChild);
            }
        }
        
        async function pollCommandes() {
            pollingCount++;
            
            try {
                const response = await fetch(`${API_BASE}/mobile_sync_api.php?action=get_commandes&coursier_id=${COURSIER_ID}`);
                const data = await response.json();
                
                if (data.success && data.commandes && data.commandes.length > 0) {
                    // Filtrer les commandes actives (nouvelle, attribuee, acceptee, en_cours, recuperee)
                    const actives = data.commandes.filter(c => 
                        ['nouvelle', 'attribuee', 'acceptee', 'en_cours', 'recuperee'].includes(c.statut)
                    );
                    
                    // Filtrer seulement les nouvelles pour la notification
                    const nouvelles = data.commandes.filter(c => c.statut === 'nouvelle');
                    
                    // D√©tecter une NOUVELLE commande (pas dans lastCommandes)
                    const nouvelleCommande = nouvelles.find(c => 
                        !lastCommandes.some(last => last.id === c.id)
                    );
                    
                    if (nouvelleCommande) {
                        addLog(`üö® NOUVELLE COMMANDE D√âTECT√âE: ${nouvelleCommande.code_commande}`, 'success');
                        showCommandeModal(nouvelleCommande);
                        showSystemNotification(nouvelleCommande);
                        playNotificationSound();
                    }
                    
                    // Afficher toutes les commandes actives
                    displayCommandes(actives);
                    
                    if (pollingCount % 10 === 0) {
                        addLog(`üîÑ Polling #${pollingCount} - ${actives.length} commande(s) active(s)`);
                    }
                    
                    lastCommandes = nouvelles; // On garde seulement les nouvelles pour la d√©tection
                } else {
                    if (lastCommandes.length > 0) {
                        addLog('‚ÑπÔ∏è Plus de commandes en attente');
                        lastCommandes = [];
                    }
                    displayNoCommandes();
                    
                    if (pollingCount % 10 === 0) {
                        addLog(`üîÑ Polling #${pollingCount} - Aucune commande`);
                    }
                }
            } catch (error) {
                addLog(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }
        
        function displayCommandes(commandes) {
            const container = document.getElementById('commandes-list');
            container.innerHTML = '';
            
            commandes.forEach(cmd => {
                const card = document.createElement('div');
                card.className = 'commande-card';
                
                // D√©terminer le badge de statut
                let statutBadge = '';
                let actionButtons = '';
                
                switch(cmd.statut) {
                    case 'nouvelle':
                    case 'attribuee':
                        statutBadge = '<span style="background:#3498db;color:white;padding:3px 10px;border-radius:12px;font-size:0.85rem;">üì¨ Nouvelle</span>';
                        actionButtons = `
                            <button class="btn btn-accept" onclick="acceptCommande(${cmd.id}, '${cmd.code_commande}')">
                                ‚úÖ Accepter
                            </button>
                            <button class="btn btn-refuse" onclick="refuseCommande(${cmd.id}, '${cmd.code_commande}')">
                                ‚ùå Refuser
                            </button>
                        `;
                        break;
                    
                    case 'acceptee':
                        statutBadge = '<span style="background:#27ae60;color:white;padding:3px 10px;border-radius:12px;font-size:0.85rem;">‚úÖ Accept√©e</span>';
                        actionButtons = `
                            <button class="btn btn-accept" onclick="startDelivery(${cmd.id}, '${cmd.code_commande}')">
                                üöÄ Commencer la livraison
                            </button>
                        `;
                        break;
                    
                    case 'en_cours':
                        statutBadge = '<span style="background:#f39c12;color:white;padding:3px 10px;border-radius:12px;font-size:0.85rem;">üö¥ En cours</span>';
                        actionButtons = `
                            <button class="btn btn-accept" onclick="pickupPackage(${cmd.id}, '${cmd.code_commande}')">
                                üì¶ J'ai r√©cup√©r√© le colis
                            </button>
                        `;
                        break;
                    
                    case 'recuperee':
                        statutBadge = '<span style="background:#e67e22;color:white;padding:3px 10px;border-radius:12px;font-size:0.85rem;">üì¶ Colis r√©cup√©r√©</span>';
                        actionButtons = `
                            <button class="btn btn-accept" onclick="markDelivered(${cmd.id}, '${cmd.code_commande}')">
                                üèÅ Marquer comme livr√©e
                            </button>
                        `;
                        break;
                }
                
                card.innerHTML = `
                    <div class="commande-header">
                        <div class="commande-code">#${cmd.code_commande}</div>
                        <div class="commande-prix">${parseFloat(cmd.prix_total).toFixed(0)} FCFA</div>
                    </div>
                    
                    <div style="margin-bottom:10px;">${statutBadge}</div>
                    
                    <div class="commande-details">
                        <div>
                            <span class="icon">üìç</span>
                            <span><strong>De:</strong> ${cmd.adresse_depart}</span>
                        </div>
                        <div>
                            <span class="icon">üéØ</span>
                            <span><strong>Vers:</strong> ${cmd.adresse_arrivee}</span>
                        </div>
                        <div>
                            <span class="icon">üìû</span>
                            <span>${cmd.client_telephone}</span>
                        </div>
                        ${cmd.description ? `
                        <div>
                            <span class="icon">üì¶</span>
                            <span>${cmd.description}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="commande-actions">
                        ${actionButtons}
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        function displayNoCommandes() {
            const container = document.getElementById('commandes-list');
            container.innerHTML = `
                <div class="no-commandes">
                    <div class="icon">üì¶</div>
                    <p>Aucune nouvelle commande</p>
                    <small>Polling actif toutes les 1 seconde</small>
                </div>
            `;
        }
        
        async function acceptCommande(commandeId, code) {
            addLog(`üöÄ Acceptation de la commande ${code}...`);
            
            try {
                const response = await fetch(`${API_BASE}/mobile_sync_api.php?action=accept_commande&coursier_id=${COURSIER_ID}&commande_id=${commandeId}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    addLog(`‚úÖ Commande ${code} accept√©e!`, 'success');
                    // Recharger imm√©diatement
                    setTimeout(pollCommandes, 500);
                } else {
                    addLog(`‚ùå Erreur: ${data.message}`, 'error');
                }
            } catch (error) {
                addLog(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }
        
        async function refuseCommande(commandeId, code) {
            addLog(`‚ùå Refus de la commande ${code}...`);
            
            try {
                const response = await fetch(`${API_BASE}/mobile_sync_api.php?action=refuse_commande&coursier_id=${COURSIER_ID}&commande_id=${commandeId}&raison=Refus depuis simulateur`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    addLog(`‚úÖ Commande ${code} refus√©e`, 'success');
                    // Recharger imm√©diatement
                    setTimeout(pollCommandes, 500);
                } else {
                    addLog(`‚ùå Erreur: ${data.message}`, 'error');
                }
            } catch (error) {
                addLog(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }
        
        function playNotificationSound() {
            // Son de notification FORT et r√©p√©titif
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Jouer 3 bips successifs
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    // Fr√©quence plus haute = plus audible
                    oscillator.frequency.value = 1200;
                    oscillator.type = 'square'; // Son plus percutant
                    
                    // Volume plus fort
                    gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                }, i * 400);
            }
            
            // Ajouter une vibration visuelle
            const phone = document.querySelector('.phone-simulator');
            phone.classList.add('alert');
            setTimeout(() => phone.classList.remove('alert'), 500);
        }
        
        function showCommandeModal(commande) {
            const modal = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            
            content.innerHTML = `
                <div class="modal-header">
                    <div class="modal-icon">üö®</div>
                    <div class="modal-title">NOUVELLE COMMANDE!</div>
                    <div style="color: #666; font-size: 0.9rem;">Code: ${commande.code_commande}</div>
                </div>
                
                <div class="modal-body">
                    <div class="modal-detail">
                        <span class="icon">üìç</span>
                        <div>
                            <strong>D√©part:</strong><br>
                            ${commande.adresse_depart || 'Non sp√©cifi√©'}
                        </div>
                    </div>
                    
                    <div class="modal-detail">
                        <span class="icon">üéØ</span>
                        <div>
                            <strong>Arriv√©e:</strong><br>
                            ${commande.adresse_arrivee || 'Non sp√©cifi√©'}
                        </div>
                    </div>
                    
                    <div class="modal-detail">
                        <span class="icon">üí∞</span>
                        <div>
                            <strong>Prix estim√©:</strong> ${commande.prix_estime || commande.prix_total || '0'} FCFA
                        </div>
                    </div>
                    
                    <div class="modal-detail">
                        <span class="icon">üìè</span>
                        <div>
                            <strong>Distance:</strong> ${commande.distance_estimee || 'N/A'} km
                        </div>
                    </div>
                    
                    ${commande.description_colis ? `
                    <div class="modal-detail">
                        <span class="icon">üì¶</span>
                        <div>
                            <strong>Colis:</strong> ${commande.description_colis}
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                <div class="modal-actions">
                    <button class="modal-btn modal-btn-accept" onclick="acceptCommandeFromModal(${commande.id}, '${commande.code_commande}')">
                        ‚úÖ ACCEPTER
                    </button>
                    <button class="modal-btn modal-btn-refuse" onclick="refuseCommandeFromModal(${commande.id}, '${commande.code_commande}')">
                        ‚ùå REFUSER
                    </button>
                </div>
            `;
            
            modal.classList.add('show');
            
            // Jouer le son de notification
            playNotificationSound();
        }
        
        function hideCommandeModal() {
            const modal = document.getElementById('modal-overlay');
            modal.classList.remove('show');
        }
        
        async function acceptCommandeFromModal(commandeId, code) {
            hideCommandeModal();
            await acceptCommande(commandeId, code);
        }
        
        async function refuseCommandeFromModal(commandeId, code) {
            hideCommandeModal();
            await refuseCommande(commandeId, code);
        }
        
        // D√©marrer le polling
        addLog('üöÄ Simulateur d√©marr√© - Polling: 1 seconde', 'success');
        pollCommandes();
        setInterval(pollCommandes, POLLING_INTERVAL);
    </script>
</body>
</html>
