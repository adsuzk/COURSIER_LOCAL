<?php
// sections/js_authentication.php - Fonctions d'authentification et gestion utilisateur
?>
    <script>
    // Variables globales d'authentification
    // Variables d'authentification - Namespace global pour √©viter les conflits
    if (!window.AuthConfig) {
        window.AuthConfig = {
            currentUser: null,
            isLoggedIn: false
        };
    }
    
    // Fonction de connexion
    function login() {
        // D√©sactiver l'avertissement beforeunload pour la connexion
        window.onbeforeunload = null;
        window._skipBeforeUnloadCheck = true;
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        if (!email || !password) {
            showMessage('Veuillez remplir tous les champs', 'error');
            return;
        }
        
        // Afficher le chargement
        showLoginLoading(true);
        
        // Simulation d'appel API (√† remplacer par votre vraie API)
        setTimeout(() => {
            // Ici vous feriez un appel AJAX √† votre API de connexion
            const loginData = {
                email: email,
                password: password
            };
            
            // Simulation de r√©ponse API
            if (email === 'test@example.com' && password === 'password') {
                currentUser = {
                    id: 1,
                    name: 'Utilisateur Test',
                    email: email,
                    phone: '+225 07 12 34 56 78'
                };
                isLoggedIn = true;
                
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                localStorage.setItem('isLoggedIn', 'true');
                
                updateUIAfterLogin();
                closeModal('loginModal');
                showMessage('Connexion r√©ussie !', 'success');
            } else {
                showMessage('Email ou mot de passe incorrect', 'error');
            }
            
            showLoginLoading(false);
        }, 1000);
    }
    
    function showLoginLoading(show) {
        const loginBtn = document.querySelector('#loginModal .btn-primary');
        if (show) {
            loginBtn.innerHTML = 'üîÑ Connexion...';
            loginBtn.disabled = true;
        } else {
            loginBtn.innerHTML = 'Se connecter';
            loginBtn.disabled = false;
        }
    }
    
    // Fonction d'inscription
    function register() {
        // D√©sactiver l'avertissement beforeunload pour l'inscription
        window.onbeforeunload = null;
        window._skipBeforeUnloadCheck = true;
        
        const name = document.getElementById('register-name').value;
        const email = document.getElementById('register-email').value;
        const phone = document.getElementById('register-phone').value;
        const password = document.getElementById('register-password').value;
        const confirmPassword = document.getElementById('register-confirm-password').value;
        
        if (!name || !email || !phone || !password || !confirmPassword) {
            showMessage('Veuillez remplir tous les champs', 'error');
            return;
        }
        
        if (password !== confirmPassword) {
            showMessage('Les mots de passe ne correspondent pas', 'error');
            return;
        }
        
        if (password.length < 6) {
            showMessage('Le mot de passe doit contenir au moins 6 caract√®res', 'error');
            return;
        }
        
        if (!isValidEmail(email)) {
            showMessage('Format d\'email invalide', 'error');
            return;
        }
        
        if (!isValidIvorianPhone(phone)) {
            showMessage('Format de num√©ro ivoirien invalide', 'error');
            return;
        }
        
        showRegisterLoading(true);
        
        // Simulation d'appel API d'inscription
        setTimeout(() => {
            const userData = {
                name: name,
                email: email,
                phone: phone,
                password: password
            };
            
            // Simulation de cr√©ation de compte
            currentUser = {
                id: Date.now(),
                name: name,
                email: email,
                phone: phone
            };
            isLoggedIn = true;
            
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            localStorage.setItem('isLoggedIn', 'true');
            
            updateUIAfterLogin();
            closeModal('signupModal');
            showMessage('Inscription r√©ussie ! Bienvenue !', 'success');
            showRegisterLoading(false);
        }, 1500);
    }
    
    function showRegisterLoading(show) {
        const registerBtn = document.querySelector('#signupModal .btn-primary');
        if (show) {
            registerBtn.innerHTML = 'üîÑ Inscription...';
            registerBtn.disabled = true;
        } else {
            registerBtn.innerHTML = 'S\'inscrire';
            registerBtn.disabled = false;
        }
    }
    
    // Fonction de d√©connexion
    function logout() {
        // D√©sactiver l'avertissement beforeunload pour la d√©connexion
        window.onbeforeunload = null;
        window._skipBeforeUnloadCheck = true;
        
        if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) {
            // Appel API pour d√©truire la session c√¥t√© serveur
            fetch(ROOT_PATH + '/api/auth.php?action=logout', {
                method: 'POST',
                credentials: 'same-origin'
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Nettoyage local
                    currentUser = null;
                    isLoggedIn = false;
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('isLoggedIn');
                    updateUIAfterLogout();
                    showMessage('Vous avez √©t√© d√©connect√©', 'info');
                    // Rechargement pour refl√©ter la session PHP
                    setTimeout(() => window.location.reload(), 500);
                } else {
                    showMessage('Erreur de d√©connexion', 'error');
                }
            })
            .catch(() => {
                showMessage('Erreur r√©seau', 'error');
            });
        }
    }
    
    // Mise √† jour de l'interface apr√®s connexion
    function updateUIAfterLogin() {
        const authButtons = document.querySelector('.auth-buttons');
        const userMenu = document.querySelector('.user-menu');
        
        if (authButtons) authButtons.style.display = 'none';
        if (userMenu) {
            userMenu.style.display = 'block';
            document.querySelector('.user-name').textContent = currentUser.name;
        }
        
        // Pr√©-remplir les champs du formulaire
        if (currentUser.phone) {
            document.getElementById('phone').value = currentUser.phone;
        }
        
        // Mettre √† jour les onglets
        updateOrderTabs();
    }
    
    // Mise √† jour de l'interface apr√®s d√©connexion
    function updateUIAfterLogout() {
        const authButtons = document.querySelector('.auth-buttons');
        const userMenu = document.querySelector('.user-menu');
        
        if (authButtons) authButtons.style.display = 'block';
        if (userMenu) userMenu.style.display = 'none';
        
        // Vider les champs du formulaire
        document.getElementById('phone').value = '';
        
        // Mettre √† jour les onglets
        updateOrderTabs();
    }
    
    // V√©rification de l'√©tat de connexion au chargement
    function checkAuthState() {
        const savedUser = localStorage.getItem('currentUser');
        const savedLoginState = localStorage.getItem('isLoggedIn');
        
        if (savedUser && savedLoginState === 'true') {
            currentUser = JSON.parse(savedUser);
            isLoggedIn = true;
            updateUIAfterLogin();
        }
    }
    
    // Fonction pour afficher le modal de compte
    function showAccount() {
        if (!isLoggedIn) {
            showModal('loginModal');
            return;
        }
        
        // Pr√©-remplir les informations dans le modal de compte
        document.getElementById('account-name').value = currentUser.name || '';
        document.getElementById('account-email').value = currentUser.email || '';
        document.getElementById('account-phone').value = currentUser.phone || '';
        
        showModal('accountModal');
    }
    
    // Fonction pour sauvegarder les modifications du compte
    function saveAccount() {
        const name = document.getElementById('account-name').value;
        const email = document.getElementById('account-email').value;
        const phone = document.getElementById('account-phone').value;
        
        if (!name || !email || !phone) {
            showMessage('Veuillez remplir tous les champs', 'error');
            return;
        }
        
        if (!isValidEmail(email)) {
            showMessage('Format d\'email invalide', 'error');
            return;
        }
        
        if (!isValidIvorianPhone(phone)) {
            showMessage('Format de num√©ro ivoirien invalide', 'error');
            return;
        }
        
        // Mettre √† jour les donn√©es utilisateur
        currentUser.name = name;
        currentUser.email = email;
        currentUser.phone = phone;
        
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        
        // Mettre √† jour l'interface
        document.querySelector('.user-name').textContent = currentUser.name;
        document.getElementById('phone').value = currentUser.phone;
        
        closeModal('accountModal');
        showMessage('Informations mises √† jour avec succ√®s', 'success');
    }
    
    // Fonction pour r√©cup√©rer le mot de passe
    function forgotPassword() {
        const email = document.getElementById('forgot-email').value;
        
        if (!email) {
            showMessage('Veuillez saisir votre adresse email', 'error');
            return;
        }
        
        if (!isValidEmail(email)) {
            showMessage('Format d\'email invalide', 'error');
            return;
        }
        
        showForgotLoading(true);
        
        // Simulation d'envoi d'email de r√©cup√©ration
        setTimeout(() => {
            showMessage('Un email de r√©cup√©ration a √©t√© envoy√© √† ' + email, 'success');
            closeModal('forgotModal');
            showForgotLoading(false);
        }, 2000);
    }
    
    function showForgotLoading(show) {
        const forgotBtn = document.querySelector('#forgotModal .btn-primary');
        if (show) {
            forgotBtn.innerHTML = 'üîÑ Envoi...';
            forgotBtn.disabled = true;
        } else {
            forgotBtn.innerHTML = 'Envoyer';
            forgotBtn.disabled = false;
        }
    }
    
    // Fonction pour basculer entre les onglets de connexion/inscription
    function showTab(tabName) {
        const tabs = document.querySelectorAll('.tab-content');
        const tabButtons = document.querySelectorAll('.tab-button');
        
        tabs.forEach(tab => {
            tab.classList.remove('active');
        });
        
        tabButtons.forEach(btn => {
            btn.classList.remove('active');
        });
        
        document.getElementById(tabName + 'Tab').classList.add('active');
        document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
    }
    </script>
