<?php
/**
 * Script de cr√©ation automatique des bases de donn√©es manquantes
 * 
 * Ce script analyse tous les fichiers SQL dans le dossier _sql,
 * identifie les bases de donn√©es requises et les cr√©e si elles n'existent pas.
 * 
 * Usage: php create_missing_databases.php
 * 
 * @author Assistant IA
 * @date 2025-09-27
 */

require_once __DIR__ . '/config.php';

class DatabaseCreator {
    
    private $connection = null;
    private $sqlDir = '';
    private $isProduction = false;
    
    public function __construct() {
        $this->sqlDir = __DIR__ . '/_sql';
        $this->detectEnvironment();
        $this->connectToMySQL();
    }
    
    /**
     * D√©termine l'environnement (production ou d√©veloppement)
     */
    private function detectEnvironment() {
        // Sur LWS, on est toujours en production
        // V√©rifie √©galement si le fichier FORCE_PRODUCTION_DB existe
        if (file_exists(__DIR__ . '/FORCE_PRODUCTION_DB') || 
            isset($_SERVER['HTTP_HOST']) && strpos($_SERVER['HTTP_HOST'], 'lws') !== false ||
            isset($_SERVER['SERVER_NAME']) && (
                strpos($_SERVER['SERVER_NAME'], 'lws') !== false ||
                strpos($_SERVER['SERVER_NAME'], 'concierge') !== false ||
                strpos($_SERVER['SERVER_NAME'], 'suzosky') !== false
            )) {
            $this->isProduction = true;
            echo "üî¥ Mode PRODUCTION d√©tect√© (serveur LWS)\n";
        } else {
            $this->isProduction = false;
            echo "üü¢ Mode D√âVELOPPEMENT d√©tect√©\n";
        }
    }
    
    /**
     * Connexion au serveur MySQL (sans sp√©cifier de base de donn√©es)
     */
    private function connectToMySQL() {
        global $config;
        
        $dbConfig = $this->isProduction ? $config['db']['production'] : $config['db']['development'];
        
        try {
            $dsn = "mysql:host={$dbConfig['host']};port={$dbConfig['port']};charset=utf8mb4";
            $this->connection = new PDO(
                $dsn,
                $dbConfig['user'],
                $dbConfig['password'],
                [
                    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
                    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
                    PDO::MYSQL_ATTR_INIT_COMMAND => "SET NAMES utf8mb4"
                ]
            );
            
            echo "‚úÖ Connexion MySQL r√©ussie vers {$dbConfig['host']}\n";
            
        } catch (PDOException $e) {
            die("‚ùå Erreur de connexion MySQL: " . $e->getMessage() . "\n");
        }
    }
    
    /**
     * Analyse tous les fichiers SQL pour extraire les noms des bases de donn√©es
     */
    private function analyzeSQLFiles() {
        $databases = [];
        
        if (!is_dir($this->sqlDir)) {
            die("‚ùå Le dossier _sql n'existe pas: {$this->sqlDir}\n");
        }
        
        $sqlFiles = glob($this->sqlDir . '/*.sql');
        
        echo "\nüìÅ Analyse de " . count($sqlFiles) . " fichiers SQL...\n";
        
        foreach ($sqlFiles as $filePath) {
            $fileName = basename($filePath);
            echo "   üìÑ Analyse de {$fileName}... ";
            
            $content = file_get_contents($filePath);
            $extractedDbs = $this->extractDatabaseNames($content, $fileName);
            
            if (!empty($extractedDbs)) {
                $databases = array_merge($databases, $extractedDbs);
                echo "‚úÖ " . count($extractedDbs) . " base(s) trouv√©e(s)\n";
            } else {
                echo "‚ö™ Aucune base sp√©cifique\n";
            }
        }
        
        return array_unique($databases);
    }
    
    /**
     * Extrait les noms de bases de donn√©es depuis le contenu SQL
     */
    private function extractDatabaseNames($content, $fileName) {
        $databases = [];
        
        // Recherche des instructions CREATE DATABASE ou USE
        $patterns = [
            '/CREATE\s+DATABASE\s+(?:IF\s+NOT\s+EXISTS\s+)?[`\'"]?([a-zA-Z0-9_]+)[`\'"]?/i',
            '/USE\s+[`\'"]?([a-zA-Z0-9_]+)[`\'"]?/i'
        ];
        
        foreach ($patterns as $pattern) {
            if (preg_match_all($pattern, $content, $matches)) {
                foreach ($matches[1] as $dbName) {
                    $databases[] = $dbName;
                }
            }
        }
        
        // Bases de donn√©es par d√©faut bas√©es sur le nom du fichier
        $defaultDatabases = $this->getDefaultDatabasesByFile($fileName);
        if (!empty($defaultDatabases)) {
            $databases = array_merge($databases, $defaultDatabases);
        }
        
        return $databases;
    }
    
    /**
     * D√©termine les bases de donn√©es par d√©faut selon le fichier
     */
    private function getDefaultDatabasesByFile($fileName) {
        global $config;
        
        $defaultDb = $this->isProduction 
            ? $config['db']['production']['name']
            : $config['db']['development']['name'];
        
        // Mapping des fichiers vers les bases de donn√©es
        $fileMapping = [
            'database_setup.sql' => [$defaultDb],
            'database_finances_setup.sql' => [$defaultDb],
            'database_telemetry_setup.sql' => [$defaultDb],
            'create_clients_table.sql' => [$defaultDb],
            'create_chat_tables.sql' => [$defaultDb],
            'create_commandes_coursier_table.sql' => [$defaultDb],
            'create_reclamations_table.sql' => [$defaultDb],
            'DEPLOY_DELIVERY_CORE.sql' => [$defaultDb],
            'DEPLOY_TELEMETRY_PRODUCTION.sql' => [$defaultDb]
        ];
        
        return $fileMapping[$fileName] ?? [$defaultDb];
    }
    
    /**
     * R√©cup√®re la liste des bases de donn√©es existantes
     */
    private function getExistingDatabases() {
        try {
            $stmt = $this->connection->query("SHOW DATABASES");
            $existing = [];
            
            while ($row = $stmt->fetch()) {
                $dbName = $row['Database'];
                // Ignore les bases syst√®me
                if (!in_array($dbName, ['information_schema', 'mysql', 'performance_schema', 'sys', 'phpmyadmin'])) {
                    $existing[] = $dbName;
                }
            }
            
            return $existing;
            
        } catch (PDOException $e) {
            die("‚ùå Erreur lors de la r√©cup√©ration des bases existantes: " . $e->getMessage() . "\n");
        }
    }
    
    /**
     * Cr√©e une base de donn√©es si elle n'existe pas
     */
    private function createDatabase($dbName) {
        try {
            $sql = "CREATE DATABASE IF NOT EXISTS `{$dbName}` 
                    CHARACTER SET utf8mb4 
                    COLLATE utf8mb4_unicode_ci";
            
            $this->connection->exec($sql);
            return true;
            
        } catch (PDOException $e) {
            echo "‚ùå Erreur lors de la cr√©ation de '{$dbName}': " . $e->getMessage() . "\n";
            return false;
        }
    }
    
    /**
     * Ex√©cute le processus principal
     */
    public function run() {
        echo "üöÄ D√©marrage du processus de cr√©ation des bases de donn√©es\n";
        echo "=" . str_repeat("=", 60) . "\n";
        
        // 1. Analyse des fichiers SQL
        $requiredDbs = $this->analyzeSQLFiles();
        
        if (empty($requiredDbs)) {
            echo "‚ö†Ô∏è  Aucune base de donn√©es trouv√©e dans les fichiers SQL\n";
            return;
        }
        
        echo "\nüìä Bases de donn√©es requises:\n";
        foreach ($requiredDbs as $db) {
            echo "   - {$db}\n";
        }
        
        // 2. V√©rification des bases existantes
        echo "\nüîç V√©rification des bases existantes...\n";
        $existingDbs = $this->getExistingDatabases();
        
        echo "üìä Bases existantes:\n";
        foreach ($existingDbs as $db) {
            echo "   - {$db}\n";
        }
        
        // 3. Cr√©ation des bases manquantes
        $missingDbs = array_diff($requiredDbs, $existingDbs);
        
        if (empty($missingDbs)) {
            echo "\n‚úÖ Toutes les bases de donn√©es requises existent d√©j√† !\n";
            return;
        }
        
        echo "\nüîß Cr√©ation des bases manquantes:\n";
        $created = 0;
        $failed = 0;
        
        foreach ($missingDbs as $dbName) {
            echo "   Cr√©ation de '{$dbName}'... ";
            
            if ($this->createDatabase($dbName)) {
                echo "‚úÖ Succ√®s\n";
                $created++;
            } else {
                echo "‚ùå √âchec\n";
                $failed++;
            }
        }
        
        // 4. R√©sum√© final
        echo "\n" . str_repeat("=", 60) . "\n";
        echo "üìã R√âSUM√â FINAL:\n";
        echo "   ‚Ä¢ Bases requises: " . count($requiredDbs) . "\n";
        echo "   ‚Ä¢ Bases existantes: " . count($existingDbs) . "\n";
        echo "   ‚Ä¢ Bases cr√©√©es: {$created}\n";
        
        if ($failed > 0) {
            echo "   ‚Ä¢ √âchecs: {$failed}\n";
        }
        
        echo "\nüéâ Processus termin√© !\n";
    }
    
    /**
     * Destructeur - ferme la connexion
     */
    public function __destruct() {
        $this->connection = null;
    }
}

// S√©curit√© basique pour l'acc√®s web
function checkWebAccess() {
    // V√©rification par token d'administration
    global $config;
    
    if (isset($_GET['token']) && $_GET['token'] === $config['admin']['api_token']) {
        return true;
    }
    
    // V√©rification par IP locale (pour d√©veloppement)
    if (isset($_SERVER['REMOTE_ADDR']) && 
        in_array($_SERVER['REMOTE_ADDR'], ['127.0.0.1', '::1', 'localhost'])) {
        return true;
    }
    
    // Si on a un token admin en session
    if (isset($_SESSION['admin_logged']) && $_SESSION['admin_logged'] === true) {
        return true;
    }
    
    return false;
}

// Ex√©cution du script
if (php_sapi_name() === 'cli') {
    // Mode ligne de commande
    $creator = new DatabaseCreator();
    $creator->run();
} else {
    // Mode web avec s√©curit√©
    
    // Interface web am√©lior√©e pour LWS
    echo "<!DOCTYPE html>
<html>
<head>
    <meta charset='UTF-8'>
    <title>üóÑÔ∏è Cr√©ation des bases de donn√©es - Suzosky</title>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Courier New', monospace; 
            background: linear-gradient(135deg, #1e3c72, #2a5298); 
            color: #fff; 
            padding: 20px; 
            margin: 0;
            min-height: 100vh;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: rgba(0,0,0,0.3); 
            border-radius: 15px; 
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 20px;
        }
        .header h1 { 
            margin: 0; 
            color: #4CAF50; 
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .header .subtitle {
            color: #ccc;
            margin-top: 10px;
        }
        .output { 
            background: rgba(45, 45, 45, 0.8); 
            padding: 20px; 
            border-radius: 10px; 
            border: 1px solid #555;
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        .success { color: #4CAF50; font-weight: bold; }
        .error { color: #f44336; font-weight: bold; }
        .warning { color: #ff9800; font-weight: bold; }
        .info { color: #2196F3; }
        .timestamp {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 20px;
        }
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #555;
            color: #aaa;
        }
        .run-button {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            text-decoration: none;
            border-radius: 5px;
            margin: 20px 0;
            font-weight: bold;
            transition: background 0.3s;
        }
        .run-button:hover {
            background: #45a049;
            color: white;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .status-prod { background: #f44336; }
        .status-dev { background: #4CAF50; }
    </style>
</head>
<body>
    <div class='container'>
        <div class='header'>
            <h1>üóÑÔ∏è Cr√©ation automatique des bases de donn√©es</h1>
            <div class='subtitle'>Syst√®me Suzosky - Serveur LWS</div>
            <div class='timestamp'>Ex√©cution du " . date('d/m/Y √† H:i:s') . "</div>
        </div>";

    // V√©rification de l'acc√®s (comment√©e pour LWS)
    /*
    if (!checkWebAccess()) {
        echo "<div class='output'>
                <div class='error'>‚ùå Acc√®s refus√©</div>
                <p>Pour ex√©cuter ce script, vous devez:</p>
                <ul>
                    <li>√ätre connect√© en tant qu'administrateur</li>
                    <li>Ou utiliser le token: <code>?token=VOTRE_TOKEN</code></li>
                    <li>Ou acc√©der depuis localhost</li>
                </ul>
              </div>";
    } else {
    */
    
    echo "<div class='output'><pre>";
    
    ob_start();
    try {
        $creator = new DatabaseCreator();
        $creator->run();
    } catch (Exception $e) {
        echo "‚ùå ERREUR CRITIQUE: " . $e->getMessage() . "\n";
        echo "üìç Fichier: " . $e->getFile() . " ligne " . $e->getLine() . "\n";
    }
    $output = ob_get_clean();
    
    // Colorisation de la sortie pour le web
    $output = str_replace("‚úÖ", "<span class='success'>‚úÖ</span>", $output);
    $output = str_replace("‚ùå", "<span class='error'>‚ùå</span>", $output);
    $output = str_replace("‚ö†Ô∏è", "<span class='warning'>‚ö†Ô∏è</span>", $output);
    $output = str_replace("üî¥", "<span class='error'>üî¥</span>", $output);
    $output = str_replace("üü¢", "<span class='success'>üü¢</span>", $output);
    $output = str_replace("üîç", "<span class='info'>üîç</span>", $output);
    $output = str_replace("üìä", "<span class='info'>üìä</span>", $output);
    $output = str_replace("üöÄ", "<span class='success'>üöÄ</span>", $output);
    
    echo $output;
    
    echo "</pre></div>";
    // } // Fin du bloc d'acc√®s s√©curis√©
    
    echo "
        <div class='footer'>
            <p>
                <a href='" . $_SERVER['PHP_SELF'] . "' class='run-button'>üîÑ R√©ex√©cuter</a>
            </p>
            <p>Script cr√©√© le " . date('d/m/Y') . " - Suzosky Coursier System</p>
        </div>
    </div>
</body>
</html>";
}
?>