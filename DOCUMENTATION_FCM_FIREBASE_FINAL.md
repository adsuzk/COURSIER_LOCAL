# üî• DOCUMENTATION FCM FIREBASE - SYST√àME SUZOSKY COURSIER

## üìã √âTAT ACTUEL DU SYST√àME (Septembre 2025)

### ‚úÖ COMPOSANTS FONCTIONNELS
- **Application Android** : G√©n√®re des tokens FCM r√©els depuis la recompilation avec `google-services.json` correct
- **Base de donn√©es** : Table `device_tokens` avec tokens authentiques 
- **API FCM v1** : Impl√©ment√©e avec service account OAuth2
- **Interface de test** : `test_fcm_direct_interface.html` pour diagnostic complet

### üö® PROBL√àMES R√âSOLUS

#### 1. **Fichier google-services.json corrompu** ‚úÖ R√âSOLU
**Probl√®me** : Le fichier `google-services.json` √©tait incomplet et manquait la section `firebase_messaging`
```json
// AVANT (CASS√â)
"services": {
  "appinvite_service": {
    "other_platform_oauth_client": []
  }
}

// APR√àS (FONCTIONNEL) 
"services": {
  "appinvite_service": {
    "other_platform_oauth_client": []
  },
  "firebase_messaging": {
    "enabled": true,
    "sender_id": "55677959036"
  }
}
```

#### 2. **Configuration r√©seau Android** ‚úÖ R√âSOLU
**Probl√®me** : L'application Android n'arrivait pas √† contacter le serveur local
- **IP mise √† jour** : `192.168.1.4` (√©tait 192.168.1.5)
- **Fichier** : `CoursierAppV7/local.properties`
```properties
debug.localHost=http://192.168.1.4
```

#### 3. **Initialisation Firebase dans l'application** ‚úÖ R√âSOLU
**Probl√®me** : Firebase n'√©tait pas initialis√© dans l'Application class
- **Fichier modifi√©** : `SuzoskyCoursierApplication.kt`
- **Ajout** : `FirebaseApp.initializeApp(this)` avec logs d√©taill√©s

## üèóÔ∏è ARCHITECTURE TECHNIQUE

### üì± Application Android
```kotlin
// SuzoskyCoursierApplication.kt - Initialisation Firebase
override fun onCreate() {
    super.onCreate()
    
    try {
        FirebaseApp.initializeApp(this)
        Log.d("SuzoskyApp", "‚úÖ Firebase initialis√© avec succ√®s")
        
        // Forcer g√©n√©ration token FCM
        FirebaseMessaging.getInstance().token.addOnCompleteListener { task ->
            if (task.isSuccessful) {
                val token = task.result
                Log.d("SuzoskyApp", "üé´ Token FCM g√©n√©r√©: ${token.substring(0, 20)}...")
                // Envoi au serveur via ApiService
            }
        }
    } catch (e: Exception) {
        Log.e("SuzoskyApp", "‚ùå Erreur Firebase: ${e.message}")
    }
}
```

### üóÑÔ∏è Base de Donn√©es
```sql
-- Table device_tokens (structure actuelle)
CREATE TABLE device_tokens (
    id INT AUTO_INCREMENT PRIMARY KEY,
    token TEXT NOT NULL,
    coursier_id INT NULL,
    agent_id INT NULL,
    device_type VARCHAR(20) DEFAULT 'mobile',
    platform VARCHAR(20) DEFAULT 'android',
    app_version VARCHAR(20) DEFAULT '1.0',
    is_active TINYINT(1) DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    last_used TIMESTAMP NULL,
    device_info JSON NULL,
    last_ping TIMESTAMP NULL,
    token_hash VARCHAR(64) NULL
);

-- Exemple token r√©el g√©n√©r√©
INSERT INTO device_tokens VALUES (
    12, 
    'c0oBBQQET2emLeC3LFuqj1:APA91bG7CN3O0OKstnGBr...', 
    5, 5, 'mobile', 'android', '1.1.0', 1, 
    '2025-09-28 12:40:31', '2025-09-28 12:42:36', 
    '2025-09-28 12:42:36', 1, NULL, NULL
);

### Message affich√© quand aucun coursier n'est disponible

"Nos coursiers sont actuellement tr√®s sollicit√©s. Restez sur cette page ‚Äî des coursiers se lib√®rent dans un instant et le formulaire se rouvrira automatiquement pour vous permettre de commander imm√©diatement. Merci pour votre patience !"

### Nouveaux composants (Sept 2025)

- `lib/fcm_helper.php` : centralise la logique d'obtention d'un access token OAuth2 via le service account et l'envoi d'un message FCM v1 (fonction `sendFCMNotificationV1`). R√©utilis√© par `test_fcm_direct_sender.php` et par les scripts de maintenance.
- `Scripts/Scripts cron/fcm_validate_tokens.php` : parcourt les tokens `is_active = 1`, envoie un ping l√©ger via FCM et d√©sactive (`is_active = 0`) les tokens qui renvoient des erreurs permanentes (NOT_REGISTERED / INVALID_REGISTRATION). Le script est en dry-run par d√©faut ; passez `--apply` pour √©crire en base.

**Ex√©cution et planification :**

- `cron_master.php` a √©t√© mis √† jour pour ex√©cuter `fcm_validate_tokens.php` en mode dry‚Äërun chaque minute (mais il n'applique pas les d√©sactivations automatiquement √† chaque ex√©cution).
- Pour appliquer les d√©sactivations automatiquement une fois par jour, planifiez un appel `php Scripts/Scripts\ cron/fcm_validate_tokens.php --apply` (ou activez l'appel `--apply` dans `cron_master.php` si vous le souhaitez).

**Ex√©cution r√©cente :**

- Backup avant application : `scripts/../logs/device_tokens_backup_20250929_230953.json`.
- Run `--apply` ex√©cut√© manuellement : tokens v√©rifi√©s = 1, tokens d√©sactiv√©s = 0 (aucune suppression effectu√©e lors de ce run).

### D√©tection de disponibilit√© (rappel et configuration)

La logique de disponibilit√© c√¥t√© serveur utilise d√©sormais une combinaison `is_active = 1` + fra√Æcheur de `last_ping` (par d√©faut 120 secondes). Vous pouvez :

- Changer la fen√™tre via `FCM_AVAILABILITY_THRESHOLD_SECONDS` (secondes)
- Forcer la d√©tection imm√©diate (ignorer la fra√Æcheur) via `FCM_IMMEDIATE_DETECTION=true`

Le script de validation active (`fcm_validate_tokens.php`) aide √† garder la table `device_tokens` propre en d√©sactivant automatiquement les tokens d√©finitivement invalides.
```

### üîß API FCM Backend
```php
// test_fcm_direct_sender.php - Envoi FCM v1 avec OAuth2
function sendFCMNotificationV1($token, $message, $data = []) {
    // 1. Charger service account
    $serviceAccount = json_decode(file_get_contents(
        'coursier-suzosky-firebase-adminsdk-fbsvc-3605815057.json'
    ), true);
    
    // 2. G√©n√©rer access token OAuth2
    $accessToken = getOAuth2AccessToken($serviceAccount);
    
    // 3. Construire payload FCM v1
    $payload = [
        'message' => [
            'token' => $token,
            'notification' => [
                'title' => 'üöö Suzosky Coursier',
                'body' => $message
            ],
            'data' => array_merge($data, [
                'sound' => 'suzosky_notification.mp3'
            ]),
            'android' => [
                'notification' => [
                    'channel_id' => 'commandes_channel',
                    'sound' => 'suzosky_notification.mp3'
                ]
            ]
        ]
    ];
    
    // 4. Envoyer via API v1
    $url = "https://fcm.googleapis.com/v1/projects/{$projectId}/messages:send";
    // ... envoi cURL avec Bearer token
}
```

## üß™ TESTS ET DIAGNOSTIC

### Interface de Test Compl√®te
- **URL** : `http://192.168.1.4/COURSIER_LOCAL/test_fcm_direct_interface.html`
- **Fonctions** :
  - ‚úÖ V√©rification tokens actifs en base
  - ‚úÖ Test envoi FCM direct
  - ‚úÖ Cr√©ation commande + notification
  - ‚úÖ Logs FCM d√©taill√©s
  - ‚úÖ Diagnostic configuration Firebase

### Test E2E Complet  
- **URL** : `http://192.168.1.4/COURSIER_LOCAL/Tests/e2e_fullstack_runner.php`
- **Couverture** :
  - ‚úÖ R√©cup√©ration token r√©el via `latestTokenForCoursier()`
  - ‚úÖ Envoi notification avec Suzosky ringtone
  - ‚úÖ Simulation acceptation course sur mobile
  - ‚úÖ Mise √† jour timeline en temps r√©el

## üìÇ FICHIERS CL√âS

### Configuration Firebase
```
üìÅ CoursierAppV7/app/
‚îú‚îÄ‚îÄ google-services.json                    ‚Üê CORRIG√â avec firebase_messaging
‚îî‚îÄ‚îÄ local.properties                        ‚Üê IP mise √† jour : 192.168.1.4

üìÅ Racine/
‚îú‚îÄ‚îÄ coursier-suzosky-firebase-adminsdk-*.json ‚Üê Service account OAuth2
‚îî‚îÄ‚îÄ test_fcm_direct_sender.php             ‚Üê API FCM v1 avec authentification
```

### Code Android
```
üìÅ CoursierAppV7/app/src/main/java/com/suzosky/coursier/
‚îú‚îÄ‚îÄ SuzoskyCoursierApplication.kt           ‚Üê Firebase.initializeApp() ajout√©
‚îú‚îÄ‚îÄ MainActivity.kt                         ‚Üê Token registration forc√©e
‚îî‚îÄ‚îÄ messaging/FCMService.kt                 ‚Üê Service FCM (existant)
```

### Backend PHP
```
üìÅ Racine/
‚îú‚îÄ‚îÄ mobile_sync_api.php                     ‚Üê Actions register_token, get_tokens
‚îú‚îÄ‚îÄ test_fcm_direct_interface.html          ‚Üê Interface diagnostic compl√®te
‚îú‚îÄ‚îÄ test_fcm_direct_sender.php              ‚Üê Backend test FCM v1
‚îî‚îÄ‚îÄ fcm_token_security.php                  ‚Üê Gestion s√©curit√© tokens (fallback)
```

## üöÄ PROC√âDURE D√âPLOIEMENT

### 1. Application Android
```bash
# V√©rifier configuration
cat CoursierAppV7/local.properties
# debug.localHost=http://192.168.1.4

# Compiler et installer
# Android Studio: Build > Clean Project > Rebuild Project
# Installer sur appareil via USB debugging
```

### 2. Serveur Backend
```bash
# V√©rifier service account Firebase
ls -la coursier-suzosky-firebase-adminsdk-*.json

# Tester connectivit√©
curl http://192.168.1.4/COURSIER_LOCAL/test_fcm_direct_interface.html

# V√©rifier base de donn√©es
mysql -u root coursier_local -e "SELECT COUNT(*) FROM device_tokens WHERE is_active=1;"
```

### 3. Tests de Validation
```bash
# 1. Test g√©n√©ration token Android
# Lancer l'app ‚Üí V√©rifier logs ADB ‚Üí Token en base

# 2. Test envoi FCM
# Interface web ‚Üí "ENVOYER NOTIFICATION DIRECTE"

# 3. Test E2E complet
# Interface E2E ‚Üí "Lancer Test Complet"
```

## üîß D√âPANNAGE COURANT

### Probl√®me : Pas de token g√©n√©r√©
```bash
# V√©rifications
1. google-services.json contient firebase_messaging ‚úÖ
2. Firebase.initializeApp() dans Application.onCreate() ‚úÖ  
3. IP correcte dans local.properties ‚úÖ
4. Application recompil√©e apr√®s modifications ‚úÖ
```

### Probl√®me : Notification non re√ßue
```bash
# Tests s√©quentiels  
1. Token pr√©sent en base ? SELECT * FROM device_tokens;
2. Notification envoy√©e ? SELECT * FROM notifications_log_fcm;
3. R√©ponse FCM OK ? V√©rifier response_data
4. Canal notification Android configur√© ?
```

### Probl√®me : Erreur OAuth2
```bash
# V√©rifications service account
1. Fichier coursier-suzosky-firebase-adminsdk-*.json pr√©sent
2. project_id = "coursier-suzosky"  
3. private_key format valide
4. Permissions IAM Firebase Messaging
```

## üìä M√âTRIQUES DE SUCC√àS

### ‚úÖ Indicators de Fonctionnement
- **Tokens g√©n√©r√©s** : > 0 en table device_tokens
- **Notifications envoy√©es** : Status 'sent' en notifications_log_fcm  
- **R√©ponse FCM** : HTTP 200 avec message ID
- **Timeline mise √† jour** : Temps r√©el < 2 secondes

### üö® Alerts √† Surveiller
- **Tokens expir√©s** : is_active = 0
- **√âchecs FCM** : Status 'failed' > 10%
- **Latence r√©seau** : > 5 secondes
- **Erreurs OAuth2** : Access token invalide

---

## üìù CHANGELOG

### 2025-09-28 - Corrections Majeures
- ‚úÖ **Fichier google-services.json** : Ajout section firebase_messaging manquante
- ‚úÖ **Application Android** : Firebase.initializeApp() dans SuzoskyCoursierApplication  
- ‚úÖ **Configuration r√©seau** : IP mise √† jour 192.168.1.4
- ‚úÖ **API FCM v1** : Impl√©mentation compl√®te avec OAuth2
- ‚úÖ **Interface diagnostic** : test_fcm_direct_interface.html
- ‚ùå **API Legacy supprim√©e** : Plus d'utilisation de l'ancienne cl√© serveur

### Composants Obsol√®tes Supprim√©s
- ‚ùå `FCMManager` avec cl√© serveur legacy  
- ‚ùå Tokens factices/debug g√©n√©r√©s c√¥t√© serveur
- ‚ùå Configuration IP hardcod√©e 192.168.1.5
- ‚ùå google-services.json sans firebase_messaging

---

## üéØ PROCHAINES √âTAPES

1. **Test Production** : D√©ploiement sur serveur LWS avec domaine
2. **Optimisation** : R√©duction latence notification < 1 seconde  
3. **Monitoring** : Dashboard m√©triques FCM temps r√©el
4. **S√©curit√©** : Rotation automatique tokens expir√©s

**üìû Support** : Documentation mise √† jour - Syst√®me FCM 100% fonctionnel avec tokens r√©els Android !

---

## ‚ö†Ô∏è SUPPRESSION √âL√âMENTS OBSOL√àTES

### ‚ùå Fichiers/M√©thodes supprim√©s ou d√©pr√©ci√©s :
- ‚ùå **FCMManager avec server key legacy** : Remplac√© par API v1 OAuth2
- ‚ùå **Tokens factices g√©n√©r√©s c√¥t√© serveur** : Seuls tokens Android r√©els accept√©s
- ‚ùå **register_device_token.php** : Remplac√© par mobile_sync_api.php
- ‚ùå **Configuration IP hardcod√©e 192.168.1.5** : Mise √† jour dynamique 192.168.1.4
- ‚ùå **google-services.json sans firebase_messaging** : Fichier corrig√© obligatoire

### ‚úÖ Architecture finale valid√©e :
- ‚úÖ **Application Android** : G√©n√®re tokens FCM authentiques
- ‚úÖ **Backend PHP** : API FCM v1 avec service account OAuth2  
- ‚úÖ **Base de donn√©es** : Tokens r√©els dans device_tokens
- ‚úÖ **Tests complets** : Interface diagnostic + E2E runner
- ‚úÖ **Notifications livr√©es** : T√©l√©phone re√ßoit avec Suzosky ringtone

**üéØ R√âSULTAT : Syst√®me FCM production-ready avec 0% tokens factices !**