{
    "generated_at": "2025-09-23T10:28:26+02:00",
    "base": "C:\\xampp\\htdocs\\COURSIER_LOCAL",
    "used_git": true,
    "sql_files": [
        "2025-09-23_add_agent_session_columns.sql"
    ],
    "changed_files": [
        "api/assign_courier.php",
        "api/auth.php",
        "api/chat/get_conversations.php",
        "api/chat/get_messages.php",
        "api/chat/init.php",
        "api/chat/send_message.php",
        "api/index.php",
        "api/profile.php",
        "api/submit_order.php",
        "cinetpay/config.php",
        "coursier_prod/cinetpay/config.php",
        "coursier_prod/config.php",
        "coursier_prod/coursier.php",
        "api/add_test_order.php",
        "api/agent_auth.php",
        "api/app_updates.php",
        "api/assign_nearest_coursier.php",
        "api/assign_with_lock.php",
        "api/chat/mark_read.php",
        "api/check_update.php",
        "api/cinetpay_callback.php",
        "api/cinetpay_stub.php",
        "api/confirm_delivery.php",
        "api/create_financial_records.php",
        "api/debug_init_recharge.php",
        "api/diagnostic_delivery_core.php",
        "api/directions_proxy.php",
        "api/generate_delivery_otp.php",
        "api/get_assigned_orders.php",
        "api/get_courier_position_for_order.php",
        "api/get_coursier_data.php",
        "api/get_coursier_info.php",
        "api/get_coursier_orders.php",
        "api/get_coursiers_positions.php",
        "api/init_recharge.php",
        "api/order_status.php",
        "api/poll_coursier_orders.php",
        "api/register_device_token.php",
        "api/set_active_order.php",
        "api/sync_pricing.php",
        "api/telemetry.php",
        "api/test_mobile_connectivity.php",
        "api/test_notification.php",
        "api/update_coursier_position.php",
        "api/update_coursier_status.php",
        "api/update_order_status.php",
        "api/upload_proof.php"
    ],
    "local_only_findings": {
        "api/auth.php": [
            {
                "line": 62,
                "label": "Test credentials reference",
                "excerpt": "// Reset password to known test password"
            },
            {
                "line": 174,
                "label": "Test credentials reference",
                "excerpt": "echo json_encode(['success' => false, 'error' => 'Email/téléphone et mot de passe requis']);"
            },
            {
                "line": 189,
                "label": "Test credentials reference",
                "excerpt": "echo json_encode(['success' => false, 'error' => 'Email/téléphone ou mot de passe incorrect']);"
            },
            {
                "line": 193,
                "label": "Test credentials reference",
                "excerpt": "// Vérifier le mot de passe"
            },
            {
                "line": 195,
                "label": "Test credentials reference",
                "excerpt": "// Premier connexion : créer le mot de passe"
            },
            {
                "line": 210,
                "label": "Test credentials reference",
                "excerpt": "'message' => 'Mot de passe créé avec succès',"
            },
            {
                "line": 221,
                "label": "Test credentials reference",
                "excerpt": "// Vérifier le mot de passe existant"
            },
            {
                "line": 244,
                "label": "Test credentials reference",
                "excerpt": "echo json_encode(['success' => false, 'error' => 'Email ou mot de passe incorrect']);"
            },
            {
                "line": 315,
                "label": "Test credentials reference",
                "excerpt": "echo json_encode(['success' => false, 'error' => \"Le mot de passe doit contenir exactement {$requiredLength} caractères\"]);"
            },
            {
                "line": 348,
                "label": "Test credentials reference",
                "excerpt": "// Hasher le mot de passe"
            },
            {
                "line": 537,
                "label": "Test credentials reference",
                "excerpt": "// Vérification du mot de passe actuel pour confirmer la modification"
            },
            {
                "line": 540,
                "label": "Test credentials reference",
                "excerpt": "echo json_encode(['success'=>false,'error'=>'Mot de passe actuel requis']);"
            },
            {
                "line": 547,
                "label": "Test credentials reference",
                "excerpt": "echo json_encode(['success'=>false,'error'=>'Mot de passe actuel incorrect']);"
            },
            {
                "line": 585,
                "label": "Test credentials reference",
                "excerpt": "// Vérifier mot de passe actuel"
            },
            {
                "line": 590,
                "label": "Test credentials reference",
                "excerpt": "echo json_encode(['success'=>false,'error'=>'Mot de passe actuel incorrect']);"
            },
            {
                "line": 597,
                "label": "Test credentials reference",
                "excerpt": "echo json_encode(['success'=>true,'message'=>'Mot de passe changé']);"
            }
        ],
        "api/index.php": [
            {
                "line": 87,
                "label": "Test credentials reference",
                "excerpt": "// Déterminer identifiant / mot de passe via multiples alias (compat V7)"
            },
            {
                "line": 144,
                "label": "Test credentials reference",
                "excerpt": "apiResponse(false, null, 'Identifiant et mot de passe requis', 400);"
            },
            {
                "line": 159,
                "label": "Plain password fallback (migration only)",
                "excerpt": "if (!$ok && !empty($agent['plain_password'])) {"
            },
            {
                "line": 160,
                "label": "Plain password fallback (migration only)",
                "excerpt": "$ok = hash_equals($agent['plain_password'], $password);"
            },
            {
                "line": 164,
                "label": "Plain password fallback (migration only)",
                "excerpt": "$upd = $pdo->prepare(\"UPDATE agents_suzosky SET password = ?, plain_password = NULL, updated_at = NOW() WHERE id = ?\");"
            },
            {
                "line": 359,
                "label": "Test credentials reference",
                "excerpt": "// Tenter d'inclure le mot de passe pour l’admin, fallback si colonne absente"
            },
            {
                "line": 389,
                "label": "Test credentials reference",
                "excerpt": "// Générer et hasher le mot de passe"
            },
            {
                "line": 466,
                "label": "Test credentials reference",
                "excerpt": "// RÉINITIALISATION MOT DE PASSE AGENT"
            },
            {
                "line": 482,
                "label": "Test credentials reference",
                "excerpt": "// Générer et hasher nouveau mot de passe"
            },
            {
                "line": 487,
                "label": "Test credentials reference",
                "excerpt": "apiLog(\"Mot de passe agent réinitialisé: ID=$id\");"
            },
            {
                "line": 488,
                "label": "Test credentials reference",
                "excerpt": "apiResponse(true, ['password' => $newPwd], 'Mot de passe réinitialisé');"
            },
            {
                "line": 495,
                "label": "Test credentials reference",
                "excerpt": "// RÉINITIALISATION MOT DE PASSE BUSINESS CLIENT"
            },
            {
                "line": 518,
                "label": "Test credentials reference",
                "excerpt": "apiLog(\"Mot de passe business client réinitialisé: ID=$id\");"
            },
            {
                "line": 519,
                "label": "Test credentials reference",
                "excerpt": "apiResponse(true, ['password' => $newPwd], 'Mot de passe réinitialisé');"
            },
            {
                "line": 525,
                "label": "Test credentials reference",
                "excerpt": "// RÉINITIALISATION MOT DE PASSE PARTICULIER"
            },
            {
                "line": 548,
                "label": "Test credentials reference",
                "excerpt": "apiLog(\"Mot de passe particulier réinitialisé: ID=$id\");"
            },
            {
                "line": 549,
                "label": "Test credentials reference",
                "excerpt": "apiResponse(true, ['password' => $newPwd], 'Mot de passe réinitialisé');"
            },
            {
                "line": 570,
                "label": "Test credentials reference",
                "excerpt": "apiResponse(false, null, 'Identifiant et mot de passe requis', 400);"
            },
            {
                "line": 579,
                "label": "Plain password fallback (migration only)",
                "excerpt": "if (!$ok && !empty($agent['plain_password'])) {"
            },
            {
                "line": 580,
                "label": "Plain password fallback (migration only)",
                "excerpt": "$ok = hash_equals($agent['plain_password'], $password);"
            },
            {
                "line": 584,
                "label": "Plain password fallback (migration only)",
                "excerpt": "$upd = $pdo->prepare(\"UPDATE agents_suzosky SET password = ?, plain_password = NULL, updated_at = NOW() WHERE id = ?\");"
            }
        ],
        "api/agent_auth.php": [
            {
                "line": 73,
                "label": "Test credentials reference",
                "excerpt": "echo json_encode(['success' => false, 'error' => 'MISSING_FIELDS', 'message' => 'Identifiant et mot de passe requis']);"
            },
            {
                "line": 82,
                "label": "Test credentials reference",
                "excerpt": "echo json_encode(['success' => false, 'error' => 'INVALID_CREDENTIALS', 'message' => 'Identifiant ou mot de passe incorrect']);"
            },
            {
                "line": 85,
                "label": "Test credentials reference",
                "excerpt": "// Vérif mot de passe"
            },
            {
                "line": 91,
                "label": "Plain password fallback (migration only)",
                "excerpt": "if (!$ok && !empty($agent['plain_password'])) {"
            },
            {
                "line": 92,
                "label": "Plain password fallback (migration only)",
                "excerpt": "$ok = hash_equals($agent['plain_password'], $password);"
            },
            {
                "line": 94,
                "label": "Plain password fallback (migration only)",
                "excerpt": "// Sécuriser: remplacer plain par hash et vider plain_password après 1ère connexion"
            },
            {
                "line": 96,
                "label": "Plain password fallback (migration only)",
                "excerpt": "$upd = $pdo->prepare(\"UPDATE agents_suzosky SET password = ?, plain_password = NULL, updated_at = NOW() WHERE id = ?\");"
            },
            {
                "line": 101,
                "label": "Test credentials reference",
                "excerpt": "echo json_encode(['success' => false, 'error' => 'INVALID_CREDENTIALS', 'message' => 'Identifiant ou mot de passe incorrect']);"
            }
        ],
        "api/init_recharge.php": [
            {
                "line": 68,
                "label": "Localhost (local-only)",
                "excerpt": "if ($host === '127.0.0.1' || $host === 'localhost') {"
            },
            {
                "line": 69,
                "label": "Emulator loopback (local-only)",
                "excerpt": "$host = '10.0.2.2';"
            }
        ],
        "api/telemetry.php": [
            {
                "line": 202,
                "label": "Localhost (local-only)",
                "excerpt": "if ($clientIP && $clientIP !== '127.0.0.1') {"
            },
            {
                "line": 231,
                "label": "Localhost (local-only)",
                "excerpt": "if ($clientIP && $clientIP !== '127.0.0.1') {"
            }
        ],
        "api/test_mobile_connectivity.php": [
            {
                "line": 32,
                "label": "Test credentials reference",
                "excerpt": "$stmt = $pdo->query(\"SELECT COUNT(*) as count FROM agents_suzosky WHERE matricule = 'CM20250001'\");"
            }
        ]
    }
}