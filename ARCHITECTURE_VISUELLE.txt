═══════════════════════════════════════════════════════════════════
    SYSTÈME COMMANDES SUZOSKY - ARCHITECTURE FINALE
═══════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────┐
│  CLIENT WEB (index.php)                                         │
│  Remplit formulaire de commande                                 │
└──────────────────────┬──────────────────────────────────────────┘
                       │ POST
                       ▼
┌─────────────────────────────────────────────────────────────────┐
│  📥 api/submit_order.php (SEUL POINT D'ENTRÉE)                  │
│                                                                  │
│  1️⃣ Valide les données reçues                                   │
│  2️⃣ Insère en BDD: statut = 'nouvelle'                          │
│  3️⃣ Cherche coursiers avec tokens FCM actifs (max 5)            │
│  4️⃣ Envoie notifications FCM (ou simule si non configuré)       │
│  5️⃣ Log diagnostic (combien notifiés, combien échoués)          │
│  6️⃣ Attribue au 1er coursier notifié: coursier_id assigné       │
│                                                                  │
│  ✅ Retourne: commande_id, coursier_id, état notifications      │
└─────────────────────────────────────────────────────────────────┘
                       │
                       │ Commande créée et attribuée
                       ▼
┌─────────────────────────────────────────────────────────────────┐
│  💾 BASE DE DONNÉES                                              │
│                                                                  │
│  commandes:                                                      │
│    - id: 148                                                     │
│    - code_commande: SZ251001125919                               │
│    - statut: 'nouvelle'     ← En attente acceptation coursier   │
│    - coursier_id: 5         ← Coursier assigné                  │
│    - adresse_depart: ...                                         │
│    - adresse_arrivee: ...                                        │
│    - prix_estime: 3500                                           │
└─────────────────────────────────────────────────────────────────┘
                       │
                       │ Polling toutes les 15 sec
                       ▼
┌─────────────────────────────────────────────────────────────────┐
│  📱 APPLICATION MOBILE COURSIER                                  │
│                                                                  │
│  GET /mobile_sync_api.php?action=get_commandes&coursier_id=5    │
│                                                                  │
│  Reçoit: [                                                       │
│    {                                                             │
│      id: 148,                                                    │
│      code_commande: "SZ251001125919",                            │
│      statut: "nouvelle",                                         │
│      adresse_depart: "...",                                      │
│      prix_total: 3500                                            │
│    }                                                             │
│  ]                                                               │
│                                                                  │
│  ┌──────────────────────────────────────┐                       │
│  │  🔔 NOUVELLE COMMANDE #SZ...919      │                       │
│  │  📍 De: Champroux Stadium           │                       │
│  │  📍 Vers: Sipim Atlantide           │                       │
│  │  💰 Prix: 3500 FCFA                 │                       │
│  │                                      │                       │
│  │  [ ✅ ACCEPTER ]  [ ❌ REFUSER ]     │                       │
│  └──────────────────────────────────────┘                       │
└─────────────────────────────────────────────────────────────────┘
                       │
          ┌────────────┴────────────┐
          │                         │
          ▼ ACCEPTER                ▼ REFUSER
┌─────────────────────┐   ┌─────────────────────┐
│ action=accept_      │   │ action=refuse_      │
│ commande            │   │ commande            │
│                     │   │                     │
│ statut → 'acceptee' │   │ coursier_id → NULL  │
│ heure_acceptation   │   │ statut → 'nouvelle' │
│   = NOW()           │   │ (réattribution)     │
└─────────────────────┘   └─────────────────────┘

═══════════════════════════════════════════════════════════════════
  FICHIERS ACTIFS
═══════════════════════════════════════════════════════════════════

✅ api/submit_order.php        - Création + Attribution
✅ mobile_sync_api.php          - API mobile (get/accept/refuse)
✅ fcm_manager.php              - Gestion notifications FCM
✅ config.php                   - Configuration BDD

═══════════════════════════════════════════════════════════════════
  FICHIERS DÉSACTIVÉS (redondants)
═══════════════════════════════════════════════════════════════════

❌ auto_assign_orders.php       - Logique déplacée dans submit_order
❌ attribution_intelligente.php - Logique déplacée dans submit_order

═══════════════════════════════════════════════════════════════════
  DIAGNOSTIC
═══════════════════════════════════════════════════════════════════

php debug_coursier_status.php   → État coursiers + dernières commandes
php test_new_order_flow.php     → Test complet du flux

Logs: diagnostic_logs/diagnostics_errors.log

═══════════════════════════════════════════════════════════════════
